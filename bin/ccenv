#!/bin/bash

CMD="$1"
HW="${!#}"
SH_CMD="${@:2}"
GRADLE_CMD="${@:2}"
NEW_MOUNT_DIR="$2"
unset VERBOSE

OPTSTRING="hv"

while getopts ${OPTSTRING} opt; do
  case ${opt} in
    h)
      unset CMD
      ;;
    v)
      VERBOSE="true"
      CMD="$2"
      SH_CMD="${@:3}"
      GRADLE_CMD="${@:3}"
      NEW_MOUNT_DIR="$3"
      ;;
    ?)
      break
      ;;
  esac
done

if [[ ${BASH_SOURCE[0]} != "$0" && $1 == "-v" ]]; then
  VERBOSE="true"
  CMD="$2"
  SH_CMD="${@:3}"
  GRADLE_CMD="${@:3}"
  NEW_MOUNT_DIR="$3"
fi

if [[ ${BASH_SOURCE[0]} != "$0" ]]; then # only source remove and reset
  if [[ $CMD != "remove" && $CMD != "reset" ]]; then
    echo "This command should not be sourced. Please the command without source"
    echo "    ccenv $CMD ${@:3}"
    return
  fi
fi

if [[ -z $CMD ]]; then
  echo "Usage: $(basename $0) -h"
  echo "       $(basename $0) [-v] cmd [bash command]"
  echo "       $(basename $0) [-v] reset [new_mount_dir]"
  echo "       $(basename $0) [-v] [ls | start | stop | remove]"
  echo "       $(basename $0) [-v] gradle [gradle command] [project root]"
  echo
  echo "* To view the project root(s) mounted to the container, run"
  echo "      $(basename $0) ls"
  echo
  echo "* To start the container, run"
  echo "      $(basename $0) start"
  echo "  - Note: The container is started by default when you run source bin/init"
  echo
  echo "* To stop the container, run"
  echo "      $(basename $0) stop"
  echo
  echo "* To remove the container, run"
  echo "      source $(basename $0) remove"
  echo
  echo "* To reset the container, run"
  echo "      source $(basename $0) reset"
  echo
  echo "* To run gradle commands, run"
  echo "      $(basename $0) gradle \"[gradle_command]\" [project_root]"
  echo
  echo "* To run bash commands, run"
  echo "      $(basename $0) cmd \"[bash_command]\""
  echo
  echo "The -h and -v flags are for help and verbose, respectively"
  ccenv ls

  exit 0
fi

case "$CMD" in
  "cmd")
    $CS132_ENV_BIN_DIR/utils/cmd.sh "$VERBOSE" "$SH_CMD"
    ;;
  "ls")
    $CS132_ENV_BIN_DIR/utils/ls.sh "$VERBOSE"
    ;;
  "start")
    $CS132_ENV_BIN_DIR/utils/start.sh "$VERBOSE"
    ;;
  "stop")
    $CS132_ENV_BIN_DIR/utils/stop.sh "$VERBOSE"
    ;;
  "remove")
    if [[ ${BASH_SOURCE[0]} == "$0" ]]; then
      echo "To run correctly, please source this script by running"
      echo "    source $(basename $0) remove"
      exit 0
    fi
    source $CS132_ENV_BIN_DIR/utils/remove.sh "$VERBOSE"
    ;;
  "reset")
    if [[ ${BASH_SOURCE[0]} == "$0" ]]; then
      echo "To run correctly, please source this script by running"
      echo "    source $(basename $0) reset"
      exit 0
    fi
    source $CS132_ENV_BIN_DIR/utils/reset.sh "$VERBOSE" "$NEW_MOUNT_DIR"
    ;;
  "gradle")
    $CS132_ENV_BIN_DIR/utils/gradle_cmd.sh "$VERBOSE" "$GRADLE_CMD" "$HW"
    ;;
esac
