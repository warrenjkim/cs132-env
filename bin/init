#!/bin/bash

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    echo "To run correctly, please source this script by running"
    echo "    source bin/init"
    exit 0
fi


# bin is already in $PATH
if [[ ! -z $CS132_ENV_BIN_DIR ]]; then
    echo "$CS132_ENV_BIN_DIR is already in \$PATH! Starting container instead..."
    echo $( cd "$CS132_ENV_BIN_DIR/docker" && docker compose up -d )

else
    export CS132_ENV_BIN_DIR="$( dirname "$( realpath "bin/init" )" )"
    echo "Created environment variable: \$CS132_ENV_BIN_DIR..."

    export CS132_ENV_MOUNT_DIR="$( realpath "${1:-.}" )"
    echo "Created environment variable: \$CS132_ENV_MOUNT_DIR..."
    echo

    echo "Detecting architecture..."
    echo "Found $ARCH"
    ARCH="$( uname -m )"
    case "$ARCH" in
        x86_64|amd64)
            export CS132_ENV_ARCH="amd64"
            ;;
        aarch64|arm64)
            export CS132_ENV_ARCH="arm64"
            ;;
        *)
            echo "$ARCH is unsupported."
            exit 1
            ;;
    esac
    echo "Created environment variable: \$CS132_ENV_ARCH... "
    echo

    echo "Prepending $CS132_ENV_BIN_DIR to \$PATH..."
    export PATH="$CS132_ENV_BIN_DIR:$PATH"
    echo "\$PATH is now $PATH"
    echo

    echo "Mounting $CS132_ENV_MOUNT_DIR to /cs132..."
    echo

    echo "============================"
    echo "Starting docker container..."
    echo "============================"
    echo $( cd "$CS132_ENV_BIN_DIR/docker" && docker compose up -d )
    export CS132_ENV_CONTAINER_NAME="$( docker ps -a | grep 'cs132-env' | awk '{print $(NF)}' )"
    echo "Created environment variable: \$CS132_ENV_CONTAINER_NAME..."
    echo "Mounted '$CS132_ENV_MOUNT_DIR' to /cs132."
    echo
fi

( cd "$CS132_ENV_BIN_DIR/docker" && \
    docker compose exec "$CS132_ENV_CONTAINER_NAME" \
    bash -c "gradle --version | grep -e \"Gradle [[:digit:]]\+\|JVM\" | tr -s [:space:] | sed -E \"s/Gradle/Gradle:/\"" )
ccenv ls
echo

echo "====="
echo "Notes"
echo "====="
echo "* To stop the container, run"
echo "      ccenv stop"
echo
echo "* To remove the container, run"
echo "      source ccenv remove"

return
